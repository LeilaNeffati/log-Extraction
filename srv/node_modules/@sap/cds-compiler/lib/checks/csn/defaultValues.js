'use strict';

const { isBetaEnabled } = require("../../base/model");

// Only to be used with validator.js - a correct this value needs to be provided!

function validateDefaultValues(member, memberName, prop, path) {
  // OData allows simple values only (val, -val, enum), no expressions or functions
  // Leave the default value check to the Database.
  // E.g. HANA allows functions on columns but only simple values on parameter definitions


  // TODO: On removal of the beta flag, filter out all illegal OData default values that are legal in the database
  //       These are all sorts of expressions, functions, $now and turn the message into appropriate warnings
  //       Or leave them as errors and get through the spec meeting.
  if(member.default && this.csn.options.toOdata && isBetaEnabled(this.csn.options, 'odataDefaultValues')) {
    // unary minus is xpr: [ "-", { val: ... } ]
    let def = member.default;
    if(member.default.xpr) {
      let i = 0;
      // consume all unary signs
      while(member.default.xpr[i] === '-' || member.default.xpr[i] === '+') i++;
      if(i>1)
        this.signal(this.error`Illegal number of unary '+/-' operators`, path);
      def = member.default.xpr[i];
    }
    if(!(def.val !== undefined || def['#'])) {
      this.signal(this.error`Default value must be a simple value for OData exposure`, path);
    }
  }
}

function rejectParamDefaultsInHanaCds(member, memberName, prop, path) {
  if(member.default && prop === 'params' && this.csn.options.toHana) {
    this.signal(this.error`Parameter default values are not supported in HANA CDS`, path);
  }
}

module.exports = { validateDefaultValues, rejectParamDefaultsInHanaCds };
